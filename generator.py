import random
import re

import os
from dotenv import load_dotenv
load_dotenv()

from openai import OpenAI
client = OpenAI(
    api_key = os.getenv("OPENAI_API_KEY")
)

import nltk
nltk.download('wordnet')
from nltk.corpus import wordnet as wn

all_nouns = [word for synset in wn.all_synsets('n') for word in synset.lemma_names()]


# get a random noun
seed = random.choice(all_nouns)
print("Seed: " + seed)

response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {
        "role": "user",
        "content": "Write a description in 2-3 sentences for a website related to " + seed
        }
    ],
    temperature=1,
    max_tokens=200,
    stop=[],
    )

websiteDescription = response.choices[0].message.content
print("Website Description: " + websiteDescription)


response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {
            "role": "system",
            "content": """
            You write PHP web code that does not depend on any external sources like a database or images. 
            If you need multiple files, respond with multiple ```php``` code blocks. The line before each code block should be a single word that is the name of the file.
            Always respond with all the files, don't truncate your response. 
            """,
        },
        {
        "role": "user",
        "content": "Write complex full website code for this website that uses two php files (including complex php code and extensive functionality): " + websiteDescription
        }
    ],
    temperature=1,
    stop=[],
    )
websiteCode = response.choices[0].message.content
print(websiteCode)

response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {
        "role": "user",
        "content": "Given this php code, explain how a XSS vulnerability could be introduced into the code in 2-3 sentences. Do not respond with any code. \n" + websiteCode
        }
    ],
    temperature=1,
    stop=[],
    )
methodToVulnerability = response.choices[0].message.content
print(methodToVulnerability)
assert(False)

response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {
            "role": "system",
            "content": """
            You write PHP web code that does not depend on any external sources like a database or images. 
            If you need multiple files, respond with multiple ```php``` code blocks. The line before each code block should be a single word that is the name of the file.
            Always respond with all the files, don't truncate your response. 
            """,
        },
        {
        "role": "user",
        "content": """
        Change the code so that this website has a XSS vulnerability.
        Do not exploit the vulnerability, just make the code vulnerable. 
        """ + websiteCode
        }
    ],
    temperature=1,
    stop=[],
    )
vulnerableCode = response.choices[0].message.content
print(vulnerableCode)

# use regex to search for php code and the line before which should contain filename 
# capture two regex groups
php_code = re.findall(r'(?P<filename>[a-zA-Z]+\.php).*?```php\n(?P<code>.*?)\n```', vulnerableCode, re.DOTALL)

# write code to files in php directory
if not os.path.exists('php'):
    os.makedirs('php')
else:
    for root, dirs, files in os.walk('php'):
        for file in files:
            os.remove(os.path.join(root, file))
for filename, code in php_code:
    with open('php/' + filename, 'w') as f:
        f.write(code)
        print(f'Wrote {filename} to php directory')