import random
import re

import os
from dotenv import load_dotenv
load_dotenv()

from openai import OpenAI
client = OpenAI(
    api_key = os.getenv("OPENAI_API_KEY")
)

def generate(technology, vulnerability):
    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {
            "role": "user",
            "content": "Give me a random idea for a website in one sentence",
            }
        ],
        temperature=1.7,
        stop=[],
        )
    websiteIdea = response.choices[0].message.content

    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {
                "role": "system",
                "content": """
                You are a developer who writes code snippets and accidentally left in the specified vulnerability. 
                """,
            },
            {
            "role": "user",
            "content": f"""
            Write a code snippet for the following website using {technology} that contains the vulnerability {vulnerability}.
            The code snippet should be enclosed in triple backticks. After the code snippet, write an explanation of how the vulnerability works, how it could be exploited, and how it could be fixed. 
            \n
            """ + websiteIdea
            }
        ],
        temperature=1,
        stop=[],
        )
    codeSnippet =  re.search(r"```.*?\n(.*?)```", response.choices[0].message.content, re.DOTALL).group(1)
    codeExplanation = re.search(r".*?```.*?```(.*)", response.choices[0].message.content, re.DOTALL).group(1)

    directory = f"snippets/{technology.lower()}"
    if not os.path.exists(directory):
        os.makedirs(directory)
    with open(f"{directory}/{vulnerability}", "w") as file:
        file.write(codeSnippet)
        file.write("\n/*\"\"\"DELIMITER\n")
        file.write(codeExplanation)


technologies = ["Node.js","React","jQuery","Express","Angular","Next.js","ASP.NET CORE","Vue.js","WordPress","ASP.NET","Flask", "Spring Boot","Django","Laravel","FastAPI",
                "AngularJS","Svelte","Ruby on Rails","NestJS","Blazor","Nuxt.js","Symfony","Deno","Gatsby","Fastify","Phoenix","Drupal","CodeIgniter","Solid.js","Remix","Elm","Play Framework","Lit","Qwik",]

vulnerability = "CWE-022"

for t in technologies:
    generate(t, vulnerability)


# TODO: prompt to ask what is the vulnerability in this code snippet - if they match explanations its valid otherwise its invalid

