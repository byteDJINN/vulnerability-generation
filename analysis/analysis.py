import json
from collections import defaultdict
import matplotlib.pyplot as plt
import csv
import sys

maxInt = sys.maxsize

while True:
    # decrease the maxInt value by factor 10 
    # as long as the OverflowError occurs.

    try:
        csv.field_size_limit(maxInt)
        break
    except OverflowError:
        maxInt = int(maxInt/10)
with open("../input/diversevul_2.json","r") as f:
    data = json.load(f)


# print out how many data points only have 1 vulnerable function

total = []
for i in data:
    count = 0 
    for j in data[i]["code"]:
        if j["target"] == 1:
            count += 1
    total.append(count)
print("Total number of data points with only 1 vulnerable function: ", sum([1 for i in total if i == 1]))
print(len(total))

assert(False)


cweDB = {}
with open("../input/2000.csv", encoding="utf-8") as f:
    c = csv.DictReader(f)
    for line in c:
        cweDB[line["CWE-ID"]] = line


cwes = defaultdict(lambda: [0,""])
for i in data:
    for c in data[i]["cwe"]:
        try:
            cwes[c][1] = cweDB[c.split("-")[1]]["Name"]
        except:
            pass
        cwes[c][0] += 1
cwes = dict(sorted(cwes.items(), key=lambda i:i[1])[::-1])


plt.bar(range(len(cwes)), [x[0] for x in cwes.values()], align="center")
# add y and x axis labels
plt.ylabel("Number of occurrences")
plt.xlabel("CWE")

# save as file
plt.show()