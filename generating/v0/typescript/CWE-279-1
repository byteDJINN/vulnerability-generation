import express from 'express';
import { exec } from 'child_process';
import { PetSitterProfile, PetOwnerProfile } from './models';

const app = express();
app.use(express.json());

// Registers new pet sitters
app.post('/register/pet-sitter', (req, res) => {
  const profileData: PetSitterProfile = req.body;

  PetSitterProfile.create(profileData)
    .then((profile) => {
      // Setting permissions for pet sitter
      exec(`./setPermissions.sh ${profile.username} pet-sitter`, (error, stdout, stderr) => {
        if (error) {
          console.error(`exec error: ${error}`);
          return res.status(500).send('Error setting permissions');
        }
        res.status(201).send(profile);
      });
    })
    .catch((error) => res.status(400).send(error.message));
});

// Registers new pet owners
app.post('/register/pet-owner', (req, res) => {
  const profileData: PetOwnerProfile = req.body;

  PetOwnerProfile.create(profileData)
    .then((profile) => {
      // Setting permissions for pet owner, but mistakenly grants pet-sitter permissions
      exec(`./setPermissions.sh ${profile.username} pet-sitter`, (error, stdout, stderr) => {
        if (error) {
          console.error(`exec error: ${error}`);
          return res.status(500).send('Error setting permissions');
        }
        res.status(201).send(profile);
      });
    })
    .catch((error) => res.status(400).send(error.message));
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});

/*"""DELIMITER
A platform that brings together pet owners and pet-sitters to seamlessly arrange care for their fur babies.