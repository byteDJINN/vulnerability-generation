import express from 'express';
import fs from 'fs';

const app = express();
const PORT = process.env.PORT || 3000;

app.post('/upload', (req, res) => {
    const { fileData, filename } = req.body;
    const filePath = `./uploads/${filename}`;

    fs.open(filePath, 'w', (err, fd) => {
        if (err) {
            console.error('Failed to open file:', err);
            return res.status(500).send('Error opening file');
        }

        fs.writeFile(filePath, fileData, (writeErr) => {
            if (writeErr) {
                console.error('Failed to write file:', writeErr);
                fs.close(fd, (closeErr) => {
                    if (closeErr) console.error('Failed to close file:', closeErr);
                });
                return res.status(500).send('Error writing file');
            }

            console.log('File uploaded successfully');
            fs.close(fd, (closeErr) => {
                if (closeErr) console.error('Failed to close file:', closeErr);
            });
            // Accidental duplicate release of file descriptor
            fs.close(fd, (closeErr) => {
                if (closeErr) console.error('Failed to close file descriptor again:', closeErr);
            });

            res.send('File uploaded successfully');
        });
    });
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});

/*"""DELIMITER
A platform where users can swap items they no longer need for virtual currency to purchase items they do need.