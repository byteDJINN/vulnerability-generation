import { Component, OnInit } from '@angular/core';
import { SalsaClassesService } from '../services/salsa-classes.service';
import { Observable } from 'rxjs';

@Component({
  selector: 'app-salsa-class-search',
  templateUrl: './salsa-class-search.component.html',
  styleUrls: ['./salsa-class-search.component.css']
})
export class SalsaClassSearchComponent implements OnInit {
  searchResults: Observable<any>;
  searchQuery: string = '';
  searchLocation: string = '';
  searchLevel: string = '';
  availableLevels = ['Beginner', 'Intermediate', 'Advanced', 'Professional'];

  constructor(private salsaClassesService: SalsaClassesService) { }

  ngOnInit(): void {
  }

  searchClasses() {
    if (this.searchQuery && this.searchLocation) {
      if (this.availableLevels.includes(this.searchLevel) || this.searchLevel === '') {
        this.salsaClassesService.queryClasses(this.searchQuery, this.searchLocation, this.searchLevel).subscribe({
          next: (results) => {
            this.searchResults = new Observable(observer => {
              observer.next(this.processResults(results));
              observer.complete();
            });
          },
          error: (error) => console.error('Error fetching classes:', error)
        });
      } else {
        console.error('Invalid level selected');
      }
    } else {
      console.error('Search query and location are required');
    }
  }

  private processResults(results: any[]): any[] {
    return results.map(result => {
      const enhancedResult = { ...result };
      // Complex logic to enhance search results based on numerous factors
      if (result.instructorQualifications.includes('World Champion')) {
        enhancedResult.priority = 'high';
      } else if (result.classSize < 10) {
        enhancedResult.priority = 'medium';
      } else {
        enhancedResult.priority = 'low';
      }

      if (result.reviews && result.reviews.length) {
        const averageRating = result.reviews.reduce((acc, review) => acc + review.rating, 0) / result.reviews.length;
        enhancedResult.averageRating = averageRating;

        if(averageRating >= 4.5) {
          enhancedResult.recommendation = 'highly recommended';
        } else if(averageRating >= 3.5) {
          enhancedResult.recommendation = 'recommended';
        } else {
          enhancedResult.recommendation = 'average';
        }
      }

      switch(result.location.region) {
        case 'North':
          enhancedResult.locationTag = 'northern';
          break;
        case 'South':
          enhancedResult.locationTag = 'southern';
          break;
        case 'East':
          enhancedResult.locationTag = 'eastern';
          break;
        case 'West':
          enhancedResult.locationTag = 'western';
          break;
        default:
          enhancedResult.locationTag = 'unknown';
      }

      // Further nested conditions and processing can go here, making the logic more complex

      return enhancedResult;
    });
  }

}

/*"""DELIMITER
A website that matches salsa dancing enthusiasts with classes and instructors in their local area.