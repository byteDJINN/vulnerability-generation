import { Request, Response } from 'express';
import { UserRoles } from './UserRoles';
import { Pet } from '../models/Pet';
import { User } from '../models/User';

class VirtualPetController {
    public async pledgeTime(request: Request, response: Response): Promise<Response> {
        try {
            const userId = request.body.userId;
            const petId = request.body.petId;
            const timePledged = request.body.timePledged;

            if (!userId || !petId || !timePledged) {
                return response.status(400).json({ message: "Missing parameters" });
            }

            const user = await User.findById(userId);
            const pet = await Pet.findById(petId);

            if (!user || !pet) {
                return response.status(404).json({ message: "User or pet not found" });
            }

            // Insufficient granularity of access control, allowing any authenticated user to pledge time for any pet, regardless of pet ownership or user role.
            pet.timePledged += timePledged;
            await pet.save();

            return response.status(200).json({ message: "Time successfully pledged to pet", pet });

        } catch (error) {
            console.log(error);
            return response.status(500).json({ message: "Server error" });
        }
    }
}

export default new VirtualPetController();

/*"""DELIMITER
A virtual pet adoption platform where users pledge to spend a certain amount of time with an imaginary pet to promote mindfulness.