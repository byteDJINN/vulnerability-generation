import express from 'express';
import bodyParser from 'body-parser';
import { authenticateUser } from './authService';
import { uploadCampaignArt } from './storageService';

const app = express();
app.use(bodyParser.json());

// Endpoint to create a new fundraising campaign
app.post('/create-campaign', authenticateUser, async (req, res) => {
  try {
    const { title, description, artistId, charityId, artwork } = req.body;
    
    if (!title || !description || !artistId || !charityId || !artwork) {
      return res.status(400).send('Missing campaign information.');
    }

    // Simulate saving campaign to database (not implemented for brevity)
    console.log('Saving campaign to database...', { title, description, artistId, charityId });

    // Upload artwork
    const artworkUrl = await uploadCampaignArt(artwork);
    console.log(`Artwork uploaded successfully: ${artworkUrl}`);

    res.status(201).send({ message: 'Campaign created successfully', artworkUrl });
  } catch (error) {
    res.status(500).send('Server error while creating campaign');
  }
});

// Alternate channel for uploading campaign artwork without authentication
app.post('/upload-artwork', async (req, res) => {
  try {
    const { artwork } = req.body;

    if (!artwork) {
      return res.status(400).send('Missing artwork.');
    }

    const artworkUrl = await uploadCampaignArt(artwork);
    console.log(`Artwork uploaded successfully: ${artworkUrl}`);

    res.status(200).send({ artworkUrl });
  } catch (error) {
    res.status(500).send('Server error while uploading artwork');
  }
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

/*"""DELIMITER
A platform connecting artists with charities in need of creative fundraising campaigns.