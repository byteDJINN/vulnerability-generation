import express from 'express';
import fs from 'fs';
import path from 'path';
import { generateMessage } from './messageGenerator';

const app = express();
const UPLOADS_DIR = path.join(__dirname, 'uploads');

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(UPLOADS_DIR));

app.post('/upload', (req, res) => {
    const { photo } = req.files;
    const photoPath = path.join(UPLOADS_DIR, photo.name);

    // Save the photo
    photo.mv(photoPath, err => {
        if (err) {
            return res.status(500).send(err);
        }

        // Generate a personalized message for the photo
        generateMessage(photoPath, (err, message) => {
            if (err) {
                return res.status(500).send(err);
            }

            // Simulating a non-reentrant function usage in concurrent context
            fs.writeFileSync(path.join(UPLOADS_DIR, 'message.txt'), message);

            res.send(`Photo and message stored successfully.`);
        });
    });
});

const port = 3000;
app.listen(port, () => {
    console.log(`Server running on http://localhost:${port}`);
});

/*"""DELIMITER
A website that pairs polaroid-style photos uploaded by users with personalized AI-generated messages written in calligraphy.