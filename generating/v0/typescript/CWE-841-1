import { Request, Response } from 'express';
import { Item, User } from './models';

// Function to handle item exchange requests
async function handleExchangeRequest(req: Request, res: Response): Promise<void> {
    const { itemId, requesterId, ownerId } = req.body;

    try {
        // Find the item based on itemId
        const item = await Item.findById(itemId);
        if (!item) {
            res.status(404).send('Item not found');
            return;
        }

        // Check if the item is available for exchange
        if (!item.available) {
            res.status(400).send('Item is not available for exchange');
            return;
        }

        // Verify that the item belongs to the ownerId provided in the request
        if (item.ownerId !== ownerId) {
            res.status(403).send('Unauthorized: You do not own this item');
            return;
        }

        // Find the requester's and owner's user accounts
        const requester = await User.findById(requesterId);
        const owner = await User.findById(ownerId);

        // A check should be here to ensure the requester and owner are not the same
        // but it's missing, leading to a potential misuse where a user could swap items with themselves.

        // Simulate the exchange - In a real app, you'd have more complex logic here
        item.ownerId = requesterId;
        await item.save();

        res.status(200).send('Exchange successful');
    } catch (error) {
        res.status(500).send('Internal server error');
    }
}

export { handleExchangeRequest };

/*"""DELIMITER
A site where users can share and swap unwanted household items with others in their community.