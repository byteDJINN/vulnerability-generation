import express from 'express';
import bodyParser from 'body-parser';
import mongoose from 'mongoose';
import bcrypt from 'bcryptjs';

const app = express();
app.use(bodyParser.json());

mongoose.connect('mongodb://localhost/swapMeetDB', { useNewUrlParser: true, useUnifiedTopology: true });

const UserSchema = new mongoose.Schema({
  username: String,
  password: String, // Storing password as a plain text or weakly encoded
  email: String,
  listings: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Listing' }],
});

const User = mongoose.model('User', UserSchema);

app.post('/sign-up', async (req, res) => {
  const { username, password, email } = req.body;

  try {
    // Weak encoding of password
    const weakEncodedPassword = Buffer.from(password).toString('base64');

    const newUser = new User({
      username,
      password: weakEncodedPassword, // Storing weakly encoded password
      email,
    });

    await newUser.save();
    res.status(200).send('User successfully registered');
  } catch (error) {
    res.status(500).send('Error registering new user');
  }
});

const port = 3000;
app.listen(port, () => {
  console.log(`Server running on port ${port}`);
});

/*"""DELIMITER
A virtual swap meet where users can list and trade items with others in their local community.