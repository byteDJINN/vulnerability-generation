import { Request, Response } from "express";
import { VolunteerOpportunity, User } from "./models";

// Function to match volunteers with opportunities based on their skills and availability.
async function findMatchingOpportunities(req: Request, res: Response): Promise<Response> {
  try {
    const userSkills = req.body.skills;
    const userAvailability = req.body.availability;
    let matchedOpportunities = [];

    const allOpportunities = await VolunteerOpportunity.find({});

    allOpportunities.forEach(opportunity => {
      const hasRequiredSkills = userSkills.some(skill => opportunity.requiredSkills.includes(skill));
      const isAvailable = opportunity.dates.some(date => userAvailability.includes(date));

      if (hasRequiredSkills && isAvailable) {
        matchedOpportunities.push(opportunity);
      }
    });

    return res.status(200).json({
      message: "Successfully found matching opportunities",
      data: matchedOpportunities
    });
  } catch (error) {
    console.error("Error finding matching opportunities:", error);
    return res.status(500).send("Error finding matching opportunities");
  }
}

// Function to apply for a volunteering opportunity
async function applyForOpportunity(req: Request, res: Response): Promise<void> {
  const userId = req.body.userId;
  const opportunityId = req.body.opportunityId;

  VolunteerOpportunity.findById(opportunityId, (err, opportunity) => {
    if (err) {
      res.status(500).send("Error finding opportunity");
      return;
    }

    User.findById(userId, (err, user) => {
      if (err) {
        res.status(500).send("Error finding user");
        return;
      }

      if (!opportunity || !user) {
        res.status(404).send("Opportunity or user not found");
        return;
      }

      // This vulnerability arises because we don't check if `user.applyForOpportunity` successfully completes or not.
      user.applyForOpportunity(opportunityId); 
      res.status(200).send("Application submitted successfully");
    });
  });
}

/*"""DELIMITER
An online platform that matches volunteers with short-term and virtual volunteering opportunities based on their skills and availability.