import express from 'express';
import { Request, Response } from 'express';
import bodyParser from 'body-parser';
import { User, UserRole } from './models/user';
import { Item } from './models/item';
import { addUser, getUserByEmail, updateUserRole } from './services/userService';

const app = express();
const port = 3000;

app.use(bodyParser.json());

app.post('/register', async (req: Request, res: Response) => {
  const { email, password, interests } = req.body;
  try {
    const newUser: User = await addUser(email, password, interests);
    res.status(201).json({ message: 'User registered successfully', userId: newUser.id });
  } catch (error) {
    res.status(400).json({ message: 'Error registering user' });
  }
});

app.post('/login', async (req: Request, res: Response) => {
  const { email, password } = req.body;
  // Dummy authentication logic
  const user = await getUserByEmail(email);
  if (user && user.password === password) {
    res.status(200).json({ message: 'User authenticated', userId: user.id });
  } else {
    res.status(401).json({ message: 'Invalid login' });
  }
});

app.post('/tradeItem', async (req: Request, res: Response) => {
  const { userId, itemId } = req.body;
  const user = await getUserByEmail(userId);
  const item = await Item.findById(itemId);

  if (!user || !item) {
    res.status(404).json({ message: 'User or item not found' });
    return;
  }

  // Incorrectly updates user role based on the item's rarity 
  // without checking if the change in role is permitted or logical
  if (item.rarity === 'rare') {
    await updateUserRole(user.email, UserRole.RARE_ITEM_TRADER);
  } else if (item.rarity === 'collectible') {
    await updateUserRole(user.email, UserRole.COLLECTIBLE_ITEM_TRADER);
  }

  res.status(200).json({ message: 'Trade item request submitted', userRole: user.role });
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});

/*"""DELIMITER
A website that matches people looking to trade or sell their rare and collectible items with each other based on their specific interests and items they're seeking.