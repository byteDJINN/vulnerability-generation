import express from 'express';
import nodemailer from 'nodemailer';

const app = express();
app.use(express.json());

// Mock database of users
const users = [
  { email: 'user@example.com', password: 'hashedPassword', securityQuestion: "What's your favorite video game?", securityAnswer: 'game123' }
];

// Email transporter setup (using nodemailer)
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: 'youremail@gmail.com',
    pass: 'yourpassword'
  }
});

app.post('/forgot-password', (req, res) => {
  const { email, securityAnswer } = req.body;
  const user = users.find(u => u.email === email);

  // Check if user exists and security answer matches
  if (user && user.securityAnswer.toLowerCase() === securityAnswer.toLowerCase()) {
    // Create a simplistic reset token (NOT SAFE)
    const resetToken = Math.random().toString(36).substring(2, 15);

    // Send email with reset token
    const mailOptions = {
      from: 'youremail@gmail.com',
      to: user.email,
      subject: 'Your Password Reset Token for the Virtual 3D Museum',
      text: `Here is your password reset token: ${resetToken}. Use this token to reset your password.`
    };

    transporter.sendMail(mailOptions, function(error, info){
      if (error) {
        console.log(error);
        res.status(500).send('Error sending email');
      } else {
        console.log('Email sent: ' + info.response);
        res.status(200).send('Reset token sent to your email.');
      }
    });
  } else {
    res.status(400).send('Invalid email or security answer.');
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

/*"""DELIMITER
A virtual online 3D museum showcasing the history of forgotten video games.