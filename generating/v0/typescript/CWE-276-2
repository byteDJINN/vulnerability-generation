import * as fs from 'fs';
import * as path from 'path';
import { Application } from 'express';
import { HostProfile } from './models/HostProfile';

const app: Application = express();

// Function to save host profile photo
app.post('/upload-profile-photo', (req, res) => {
  if (req.files) {
    let profilePhoto = req.files.profilePhoto;
    // Assuming /public/uploads is accessible to the public
    let uploadPath = path.join(__dirname, '/public/uploads/', profilePhoto.name);
    profilePhoto.mv(uploadPath, function(err) {
      if (err) {
        return res.status(500).send(err);
      }

      let newPhotoPath = `/uploads/${profilePhoto.name}`;
      HostProfile.updateOne({ _id: req.body.hostId }, { $set: { photo: newPhotoPath } }, (error, result) => {
        if (error) {
          res.status(500).send(error);
        } else {
          res.send({ message: 'File uploaded!', data: newPhotoPath });
        }
      });
    });

    // Set public read permissions by default
    fs.chmod(uploadPath, 0o644, (err) => {
      if (err) {
        console.error(`Failed to set default permissions for ${profilePhoto.name}`);
      }
    });
  } else {
    res.status(400).send('No file uploaded.');
  }
});


app.listen(3000, () => {
  console.log('Server running on port 3000');
});

/*"""DELIMITER
A platform that connects wanderlust individuals with local hosts for unique expat experiences.