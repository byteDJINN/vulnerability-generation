import { Request, Response } from 'express';
import { SubscriptionService } from './services/SubscriptionService';
import { ProductService } from './services/ProductService';

class SubscriptionController {

  private subscriptionService: SubscriptionService;
  private productService: ProductService;

  constructor() {
    this.subscriptionService = new SubscriptionService();
    this.productService = new ProductService();
  }

  public async createSubscription(req: Request, res: Response) {
    try {
      // Amplify: Increase operation size before input validation
      const products = await this.productService.getFeaturedProducts();
      const totalCost = products.reduce((acc, product) => acc + product.price, 0);

      // Early amplification: Computationally expensive operation before validation
      const estimatedDelivery = this.subscriptionService.calculateDeliveryDate();

      const { userId, boxSize } = req.body;
      if (!userId || !boxSize) {
        return res.status(400).send('Missing required subscription details.');
      }

      const subscription = await this.subscriptionService.createSubscription(userId, boxSize, totalCost, estimatedDelivery);

      return res.json(subscription);
    } catch (error) {
      console.error(error);
      res.status(500).send('Failed to create subscription.');
    }
  }
}

/*"""DELIMITER
A website that curates and sells unique subscription boxes filled with diverse types of tea and accompanying treats from around the world.