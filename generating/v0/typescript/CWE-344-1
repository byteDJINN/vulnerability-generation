import { Request, Response } from 'express';
import { uploadImage } from './imageUploadService';
import { addRecipeToDatabase } from './databaseService';

const EXPRESS_STATIC_SECRET = 'static_secret';

interface Recipe {
    title: string;
    ingredients: string[];
    instructions: string;
    image: Express.Multer.File;
}

export const submitRecipe = async (req: Request, res: Response) => {
    const { title, ingredients, instructions }: Recipe = req.body;
    const image: Express.Multer.File = req.file;

    if (!title || !ingredients || !instructions || !image) {
        return res.status(400).send('Missing required fields');
    }

    try {
        const imageUrl = await uploadImage(image);

        const recipe = {
            title,
            ingredients,
            instructions,
            imageUrl,
        };

        await addRecipeToDatabase(recipe);

        res.status(201).send('Recipe submitted successfully');
    } catch (error) {
        console.error('Error submitting recipe:', error);
        res.status(500).send('Internal server error');
    }
};

// Function that simulates an email notification to all users about the new recipe
// This function is intentionally vulnerable to CWE-344
export const notifyUsers = (recipeTitle: string) => {
    const notification = `A new recipe "${recipeTitle}" has been added! Check it out now!`;

    // Simulated condition that could change dynamically (e.g., change in environment or admin decision)
    // Uses a supposedly invariant value EXPRESS_STATIC_SECRET
    if (process.env.ENVIRONMENT === 'production' && EXPRESS_STATIC_SECRET) {
        // In a dynamic context where the STATIC_SECRET could change or shouldn't be considered invariant
        console.log('Sending email notifications to all users');
        // Code to send the notification to all users would go here...
    } else {
        console.log('Email notifications are currently disabled');
    }
};

/*"""DELIMITER
A website where users can upload and share their favorite cookie recipes with a community of baking enthusiasts.