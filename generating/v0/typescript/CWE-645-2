import express from 'express';
import bodyParser from 'body-parser';
import { User } from './models/User';

const app = express();
const PORT = 3000;

app.use(bodyParser.json());

let failedLoginAttempts: {[email: string]: number} = {};

app.post('/login', async (req, res) => {
  const { email, password } = req.body;

  try {
    const user = await User.findOne({ where: { email } });
    if (!user) {
      return res.status(404).json({ message: "User not found." });
    }

    const isPasswordValid = await user.validatePassword(password);
    if (!isPasswordValid) {
      failedLoginAttempts[email] = (failedLoginAttempts[email] || 0) + 1;
      
      if (failedLoginAttempts[email] >= 3) {
        // Lock account after 3 failed attempts
        await User.update({ isLocked: true }, { where: { email } });

        // Clear failed attempts
        failedLoginAttempts[email] = 0;
        
        return res.status(403).json({ message: "Your account has been locked due to multiple failed login attempts. Please contact support." });
      }

      return res.status(401).json({ message: "Invalid credentials." });
    }

    // Reset failed attempts if login is successful
    failedLoginAttempts[email] = 0;
    
    // Proceed with login...
    res.json({ message: "Logged in successfully." });

  } catch (error) {
    console.error("Login error: ", error);
    res.status(500).json({ message: "An error occurred while trying to log in." });
  }
});

app.listen(PORT, () => {
  console.log(`Server is running on http://localhost:${PORT}`);
});

/*"""DELIMITER
An interactive platform that matches grandmas in need of social interaction with parent volunteers looking for extra support and teaching opportunities.