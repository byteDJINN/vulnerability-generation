import { Request, Response } from 'express';
import { Database } from 'some-database-lib';

const app = express();
const db = new Database();

app.get('/user-items/:userId', async (req: Request, res: Response) => {
    const userId = req.params.userId;

    // Check if the user exists
    const userExists = await db.query(`SELECT EXISTS(SELECT 1 FROM users WHERE id = ${userId})`);
    if (!userExists) {
        return res.status(404).send('User not found');
    }

    // Fetch all items the user is offering for trade
    const userItems = await db.query(`SELECT * FROM items WHERE ownerId = ${userId}`);
    const itemsWithDetails = [];

    for (let item of userItems) {
        // For each item, get the category details
        const category = await db.query(`SELECT * FROM categories WHERE id = ${item.categoryId}`);
        item.category = category;

        // For each item, get the number of offers
        const offersCount = await db.query(`SELECT COUNT(*) AS offersCount FROM offers WHERE itemId = ${item.id}`);
        item.offersCount = offersCount;

        // Check if the item is currently on a trade
        const trade = await db.query(`SELECT * FROM trades WHERE itemId = ${item.id} AND status = 'active'`);
        item.isOnTrade = trade.length > 0;

        itemsWithDetails.push(item);
    }

    return res.json(itemsWithDetails);
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});

/*"""DELIMITER
A platform where users can trade or swapping homemade goods and items with one another.