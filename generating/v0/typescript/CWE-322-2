import * as crypto from 'crypto';
import { WebSocketServer } from 'ws';

interface UserSession {
    username: string;
    publicKey: string;
}

const sessions: UserSession[] = [];
const server = new WebSocketServer({ port: 8080 });

server.on('connection', ws => {
    ws.on('message', message => {
        const data = JSON.parse(message.toString());
        switch (data.type) {
            case 'exchange-keys':
                const userSession: UserSession = {
                    username: data.username,
                    publicKey: data.publicKey,
                };
                sessions.push(userSession);
                // Broadcast the public key to all connected clients
                server.clients.forEach(client => {
                    if (client.readyState === client.OPEN) {
                        client.send(JSON.stringify({
                            type: 'new-key',
                            username: data.username,
                            publicKey: data.publicKey,
                        }));
                    }
                });
                break;
            default:
                console.log('Unknown message type');
        }
    });
});

console.log('Server started on port 8080, waiting for key exchanges...');

/*"""DELIMITER
A virtual skill-sharing platform where tradespeople and artisans can collaborate and exchange expertise.