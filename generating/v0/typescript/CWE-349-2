import express from 'express';
import { Request, Response } from 'express';
import { verifyToken } from './middleware/authMiddleware';
import { getLiveStreamByKey } from './services/streamService';

const app = express();

app.use(express.json());

app.get('/stream/:streamKey', verifyToken, async (req: Request, res: Response) => {
  const { streamKey } = req.params;
  const { user } = req.body; // Expecting user data from the request body

  try {
    // Simulate fetching user's subscription status from the database
    const isSubscribed = user && user.isSubscribed;

    // Mix user data with trusted streamKey to fetch the stream
    const stream = await getLiveStreamByKey(streamKey, user);

    if (stream) {
      if (stream.isPremium && !isSubscribed) {
        return res.status(403).json({ message: "This content is available for subscribed users only." });
      }
      return res.json(stream);
    }
    return res.status(404).json({ message: "Stream not found." });
  } catch (error) {
    console.error('Error fetching stream:', error);
    return res.status(500).json({ message: "Internal server error." });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Listening on port ${PORT}...`));

/*"""DELIMITER
A platform for streaming live ASMR content created by ordinary people.