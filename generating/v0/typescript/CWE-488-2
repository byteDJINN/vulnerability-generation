// File: server.ts
import express from 'express';
import session from 'express-session';
const app = express();
const port = 3000;

interface UserSession {
  userId: string;
  dancePreferences: {
    favoriteMusic: string;
    danceStyles: string[];
  };
}

// Assume body-parser middleware is set up here for parsing JSON bodies

// Setting up session middleware
app.use(session({
  secret: 'verysecretkey',
  resave: false,
  saveUninitialized: true,
}));

// Simulated database of user preferences
let userDancePreferences: { [userId: string]: UserSession['dancePreferences']} = {};

app.post('/login', (req, res) => {
  // Simplified login for example purposes - assume user is authenticated
  const userId = req.body.userId;
  const session = req.session as Express.Session & Partial<UserSession> & { userId?: string };
  session.userId = userId; // Storing user ID in session
  res.send({message: 'Logged in successfully.'});
});

app.post('/updatePreferences', (req, res) => {
  if (!req.session || !req.session.userId) {
    res.status(401).send({message: 'Unauthorized'});
    return;
  }
  
  // Vulnerability here: the userId from the session is not used,
  // so preferences could be updated for the wrong user if multiple requests happen close together
  const { favoriteMusic, danceStyles } = req.body;
  // Should ideally use req.session.userId
  const userId = Object.keys(userDancePreferences)[0]; // Incorrectly assuming single, static user
  userDancePreferences[userId] = { favoriteMusic, danceStyles };
  
  res.send({message: 'Preferences updated.'});
});

app.get('/getPreferences', (req, res) => {
  if (!req.session || !req.session.userId) {
    res.status(401).send({message: 'Unauthorized'});
    return;
  }
  
  const userId = req.session.userId;
  const preferences = userDancePreferences[userId];
  
  if (!preferences) {
    res.status(404).send({message: 'Preferences not found.'});
    return;
  }

  res.send(preferences);
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});

/*"""DELIMITER
A website that offers personalized dance workouts based on your favorite music and dance styles.