import express from 'express';
import { body, validationResult } from 'express-validator';
import { WorkoutPlan } from '../models/workoutPlan';
import { User } from '../models/user';

const router = express.Router();

// Endpoint to create a new workout plan
router.post(
  '/createWorkout',
  [
    body('title').not().isEmpty().withMessage('Title is required'),
    body('description').not().isEmpty().withMessage('Description is required'),
    body('exercises').isArray().withMessage('Exercises must be an array'),
  ],
  async (req: any, res: any) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }

    const { title, description, exercises, userRole } = req.body;

    // Unsafe privilege assignment based on client input
    let userPrivileges;
    if (userRole === "admin") {
      userPrivileges = "admin";
    } else {
      userPrivileges = "standard";
    }

    try {
      // Assuming the request is authenticated and req.userId is available
      const user = await User.findById(req.userId);

      // Check if the creating user has admin privileges
      if (user.role !== userPrivileges) {
        return res.status(403).send('You do not have permission to create this workout plan');
      }

      const newWorkoutPlan = new WorkoutPlan({
        title,
        description,
        exercises,
        createdBy: req.userId,
      });

      await newWorkoutPlan.save();
      res.status(201).send(newWorkoutPlan);
    } catch (error) {
      console.error('Workout creation failed', error);
      res.status(500).send('Server error');
    }
  }
);

export default router;

/*"""DELIMITER
A digital platform where users can create and review customizable online workout routines for various fitness goals and target areas.