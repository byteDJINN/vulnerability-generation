import express from 'express';
import axios from 'axios';
import { Pool } from 'pg';

const app = express();
const PORT = 3000;

// Initialize PostgreSQL client pool
const pool = new Pool({
    user: 'user',
    host: 'localhost',
    database: 'plantsdb',
    password: 'password',
    port: 5432,
    max: 10, // Maximum number of clients in the pool
    idleTimeoutMillis: 30000, // Close idle clients after 30s
});

app.use(express.json());

app.get('/api/plants', async (req, res) => {
    // Fetch list of plants from the database
    try {
        const client = await pool.connect();
        const result = await client.query('SELECT * FROM plants');
        res.json(result.rows);
        client.release();
    } catch (err) {
        console.error(err);
        res.status(500).send('Server error');
    }
});

app.post('/api/trade', async (req, res) => {
    const { plantId, userId, offer } = req.body;

    // Simulate an external API call to a payment/shipment service
    try {
        const response = await axios.post('https://api.external-service.com/ship', {
            plantId,
            userId,
            offer,
        });

        if (response.status === 200) {
            res.json({ message: 'Trade successfully initiated!' });
        } else {
            res.status(500).send('Error initiating trade');
        }
    } catch (err) {
        console.error(err);
        res.status(500).send('Error calling external service');
    }
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});

/*"""DELIMITER
An online marketplace for buying and trading plants, connecting enthusiasts from around the world to share their houseplant collections and expertise.