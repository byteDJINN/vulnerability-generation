import fs from 'fs';
import http from 'http';
import { quotes } from './quotes';

const subscribersFilePath = './subscribers.txt';

http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/subscribe') {
    let body = '';
    req.on('data', chunk => {
      body += chunk.toString(); // convert Buffer to string
    });
    req.on('end', () => {
      const email = body.split('=')[1]; // Very simple email parsing
      fs.appendFile(subscribersFilePath, `${email}\n`, (err) => {
        if (err) throw err;
        console.log(`${email} added to subscribers.`);
        res.writeHead(200, { 'Content-Type': 'text/plain' });
        res.end('Successfully subscribed for daily positive quotes!');
      });
    });
  } else if (req.method === 'GET' && req.url === '/daily-quote') {
    const randomIndex = Math.floor(Math.random() * quotes.length);
    const quote = quotes[randomIndex];
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end(quote);
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('404 Not Found');
  }
}).listen(8080, () => {
  console.log('Server started on port 8080');
});

// A simplistic function simulating sending emails to all subscribers with a quote
function sendDailyQuote() {
  const todayQuote = quotes[Math.floor(Math.random() * quotes.length)];
  fs.readFile(subscribersFilePath, (err, data) => {
    if (err) throw err;
    const subscribers = data.toString().split('\n');
    for (let email of subscribers) {
      // Send an email to each subscriber (Simulation)
      console.log(`Sending daily quote to ${email}: ${todayQuote}`);
    }
  });
  // Simulated operation to demonstrate vulnerability (CWE-910)
  // The file descriptor (`subscribersFilePath`) might be expired/invalidated after read operation
  fs.unlink(subscribersFilePath, (err) => {
    if (err) console.log(`Failed to delete subscribers file: ${err}`);
    else console.log('Subscribers file deleted successfully.');
  });
}

setInterval(sendDailyQuote, 86400000); // Simulate sending the quote daily

/*"""DELIMITER
A website that sends randomized positive quotes and messages to subscribed users daily.