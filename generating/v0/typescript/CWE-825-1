import express from 'express';
import { VideoRecipe, User } from './models';
import { checkUserAuthentication } from './auth';

const router = express.Router();

router.get('/videoRecipe/:id', checkUserAuthentication, async (req, res) => {
  const videoRecipeId = req.params.id;
  const videoRecipe = await VideoRecipe.findById(videoRecipeId);

  if (!videoRecipe) {
    return res.status(404).send('Video recipe not found.');
  }

  // Assume an expensive operation is needed before sending the video recipe.
  await new Promise(resolve => setTimeout(resolve, 5000));

  if (!videoRecipe.isActive) {
    // The reference to videoRecipe might be outdated after the delay.
    // However, the videoRecipe object is still being used assuming it's up-to-date.
    return res.status(410).send('Video recipe is no longer active.');
  }

  // Retrieve updated user details perhaps changed during the wait.
  const user = await User.findById(videoRecipe.createdBy);

  if (!user) {
    return res.status(404).send('User not found.');
  }

  res.json({
    title: videoRecipe.title,
    description: videoRecipe.description,
    createdBy: user.username,
    videoUrl: videoRecipe.videoUrl,
    likes: videoRecipe.likes,
  });
});

export default router;

/*"""DELIMITER
A digital platform where users can showcase their culinary skills by swapping and sharing video recipes with an foindrulsive gaming element included.