import os
import random
import json
import re
from dotenv import load_dotenv

import DS
from Generator423 import Generator423

load_dotenv()



if __name__ == "__main__":
    load_dotenv()
    apiKey = os.getenv("OPENAI_API_KEY")
    generator423 = Generator423(apiKey)

    cweDB = {}
    with open("../../input/2000.csv", "r", encoding="utf-8") as file:
        cweDB = {f"CWE-{line.split(',')[0]}": line.split(",")[1] for line in file.readlines()}

    # data = DS.Handler("../../input/diversevul_3.json")
    # print(data.length(DS.SINGLE))

    data = []
    with open("../../input/pse_filtered.json","r", encoding="utf-8") as file:
        data = json.load(file)

    # open all the json files in 423 folder and record their uids
    uids = []
    for file in os.listdir("423"):
        with open(f"423/{file}", "r") as f:
            data1 = json.load(f)
            uids.append(data1["uid"])

    for i in range(len(data)):
        #cwe, vuln, safe = data.get(i, DS.SINGLE, DS.SEMANTIC)
        #inp = vuln[0]

        if data[i]["uid"] in uids:
            print("skipping", data[i]["uid"])
            continue

        cwe = data[i]["cwe_identifier"]
        inp = data[i]["pure_code"]

        if inp is None:
            continue

        if len(inp) < 20 or len(inp) > 4000:
            continue

        
        generator423.generateCodeSnippet(cwe, data[i]["pattern_desc"], inp, uid=data[i]["uid"])
        print(generator423.totalCost)

        
    

    