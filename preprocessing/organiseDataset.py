
import json

data = []
with open("../input/diversevul.json", "r") as f:
    for fline in f:
        data.append(json.loads(fline))  

context = {}
with open("f_diversevul_context.json", "r") as f:  
    context = json.load(f)

output = {}
"""
commit id
	message
	project
	cwe
	files
		url
	functions 
		code
		size
		target
"""

for line in data:
    # if line['commit_id'] not in context:
    #     print(f"no context: {line['commit_id']}")
    #     continue
    if line['target'] == 1:
        if line['commit_id'] not in output:
            output[line['commit_id']] = {}
            output[line['commit_id']]["message"] = line['message']
            output[line['commit_id']]["project"] = line['project']
            output[line['commit_id']]["cwe"] = line['cwe']
            #output[line['commit_id']]["files"] = context[line['commit_id']]
            output[line['commit_id']]["code"] = []
        output[line['commit_id']]["code"].append({"func": line['func'], "size": line['size'], "target": line['target']})

    else:
        if line['commit_id'] not in output:
            output[line['commit_id']] = {}
            output[line['commit_id']]["message"] = line['message']
            output[line['commit_id']]["project"] = line['project']
            output[line['commit_id']]["cwe"] = line['cwe']
            #output[line['commit_id']]["files"] = context[line['commit_id']]
            output[line['commit_id']]["code"] = []
        output[line['commit_id']]["code"].append({"func": line['func'], "size": line['size'], "target": line['target']})


with open("diversevul_2.json", "w") as f:
    json.dump(output, f, indent=4)
