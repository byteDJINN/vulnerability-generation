
import json

data = []
with open("../input/diversevul.json", "r") as f:
    for fline in f:
        data.append(json.loads(fline))  

context = {}
with open("f_diversevul_context.json", "r") as f:  
    context = json.load(f)

output = {"vuln": {}, "safe": {}}
"""
target
	commit id
		message
		project
		cwe
		files
			url
		code 
			func
			size
"""

def check(line):
    # assuming it exists, checks if any of message, project or cwe are different
    if line['commit_id'] in output["vuln"]:
        if output["vuln"][line['commit_id']]["message"] != line['message']:
            print(f"message: {line['commit_id']}")
        if output["vuln"][line['commit_id']]["project"] != line['project']:
            print(f"project: {line['commit_id']}")
        if output["vuln"][line['commit_id']]["cwe"] != line['cwe']:
            print(f"cwe: {line['commit_id']}")
    if line['commit_id'] in output["safe"]:
        if output["safe"][line['commit_id']]["message"] != line['message']:
            print(f"message: {line['commit_id']}")
        if output["safe"][line['commit_id']]["project"] != line['project']:
            print(f"project: {line['commit_id']}")
        if output["safe"][line['commit_id']]["cwe"] != line['cwe']:
            print(f"cwe: {line['commit_id']}")

for line in data:
    if line['commit_id'] not in context:
        print(f"no context: {line['commit_id']}")
        continue
    if line['target'] == 1:
        if line['commit_id'] not in output["vuln"]:
            output["vuln"][line['commit_id']] = {}
            output["vuln"][line['commit_id']]["message"] = line['message']
            output["vuln"][line['commit_id']]["project"] = line['project']
            output["vuln"][line['commit_id']]["cwe"] = line['cwe']
            output["vuln"][line['commit_id']]["files"] = context[line['commit_id']]
            output["vuln"][line['commit_id']]["code"] = []
        output["vuln"][line['commit_id']]["code"].append({"func": line['func'], "size": line['size']})
        check(line)
    else:
        if line['commit_id'] not in output["safe"]:
            output["safe"][line['commit_id']] = {}
            output["safe"][line['commit_id']]["message"] = line['message']
            output["safe"][line['commit_id']]["project"] = line['project']
            output["safe"][line['commit_id']]["cwe"] = line['cwe']
            output["safe"][line['commit_id']]["files"] = context[line['commit_id']]
            output["safe"][line['commit_id']]["code"] = []
        output["safe"][line['commit_id']]["code"].append({"func": line['func'], "size": line['size']})
        check(line)

with open("diversevul_2.json", "w") as f:
    json.dump(output, f, indent=4)
